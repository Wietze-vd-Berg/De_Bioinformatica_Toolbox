<h2>Je bestand wordt verwerkt...</h2>
<p id="status-message">Even geduld aub. Status wordt geladen...</p>

<ul id="verwerking-voortgang" class="text-lg mt-4 space-y-1">
    <li id="step-index">Salmon index: ‚è≥</li>
    <li id="step-quant">Salmon quant: ‚è≥</li>
    <li id="step-chart">Genereren grafiek: ‚è≥</li>
</ul>

<script>
  const taskId = "{{ task_id }}";

  function updateVoortgang(step, status) {
    const icons = {
      queued: "‚è≥",
      processing: "üîÑ",
      done: "‚úÖ",
      error: "‚ùå"
    };

    const stappen = ["index", "quant", "chart"];
    stappen.forEach(s => {
      const el = document.getElementById("step-" + s);
      if (!el) return;
      if (s === step) {
        el.innerHTML = el.innerText.split(":")[0] + ": " + icons[status];
      } else if (el.innerText.includes("‚è≥")) {
        el.innerHTML = el.innerText.split(":")[0] + ": " + icons["queued"];
      }
    });
  }

  function checkStatus() {
    fetch("/status/" + taskId)
      .then(response => response.json())
      .then(data => {
        updateVoortgang(data.step, data.status);

        if (data.status === "done") {
          window.location.href = "/resultaat/" + taskId;
        } else if (data.status === "error") {
          document.getElementById("status-message").innerHTML = "<strong style='color:red;'>Fout tijdens verwerking: " + (data.error || "onbekend") + "</strong>";
        } else {
          setTimeout(checkStatus, 3000);
        }
      });
  }

  checkStatus();
</script>